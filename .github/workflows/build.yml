name: Build

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  # ===========================================================================
  # Build standalone executables for each platform
  # ===========================================================================
  build-standalone:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            artifact_name: flutterator
            asset_name: flutterator-linux
          - os: macos-latest
            artifact_name: flutterator
            asset_name: flutterator-macos
          - os: windows-latest
            artifact_name: flutterator.exe
            asset_name: flutterator-windows.exe

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller click jinja2 rich pyyaml

      - name: Build with PyInstaller
        run: |
          pyinstaller --onefile --name flutterator --clean --noconfirm --add-data "generators:generators" --hidden-import click --hidden-import jinja2 --hidden-import rich --hidden-import rich.console --hidden-import rich.panel --hidden-import rich.tree --hidden-import rich.text --hidden-import yaml flutterator.py
        shell: bash

      - name: Build with PyInstaller (Windows fix)
        if: matrix.os == 'windows-latest'
        run: |
          pyinstaller --onefile --name flutterator --clean --noconfirm --add-data "generators;generators" --hidden-import click --hidden-import jinja2 --hidden-import rich --hidden-import rich.console --hidden-import rich.panel --hidden-import rich.tree --hidden-import rich.text --hidden-import yaml flutterator.py
        shell: cmd

      - name: Rename artifact
        run: |
          mv dist/${{ matrix.artifact_name }} dist/${{ matrix.asset_name }}
        shell: bash
        if: matrix.os != 'windows-latest'

      - name: Rename artifact (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          move dist\${{ matrix.artifact_name }} dist\${{ matrix.asset_name }}
        shell: cmd

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}
          path: dist/${{ matrix.asset_name }}

  # ===========================================================================
  # Create release with all artifacts
  # ===========================================================================
  release:
    needs: build-standalone
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Get version from build.sh
        id: version
        run: |
          VERSION=$(grep 'VERSION=' build.sh | head -1 | cut -d'"' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/

      - name: List artifacts
        run: |
          echo "Downloaded artifacts:"
          find dist/ -type f
          ls -la dist/

      - name: Prepare release files
        run: |
          mkdir -p release
          # Move executables to release folder with correct names
          mv dist/flutterator-linux/flutterator-linux release/
          mv dist/flutterator-macos/flutterator-macos release/
          mv dist/flutterator-windows.exe/flutterator-windows.exe release/
          chmod +x release/flutterator-linux release/flutterator-macos
          ls -la release/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Flutterator ${{ steps.version.outputs.version }}
          body: |
            ğŸš€ **Flutterator ${{ steps.version.outputs.version }}** - Standalone Executables

            **No Python or dependencies required!** Just download and run.

            ## ğŸ“¥ Download for your platform:

            | Platform | File | 
            |----------|------|
            | ğŸ macOS | `flutterator-macos` |
            | ğŸ§ Linux | `flutterator-linux` |
            | ğŸªŸ Windows | `flutterator-windows.exe` |

            ## ğŸš€ Quick Start:

            **macOS/Linux:**
            ```bash
            # Download
            curl -L -o flutterator "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/flutterator-macos"
            # or flutterator-linux for Linux

            # Make executable
            chmod +x flutterator

            # Move to PATH (optional)
            sudo mv flutterator /usr/local/bin/

            # Use!
            flutterator --help
            flutterator create --name myapp
            ```

            **Windows:**
            ```cmd
            REM Download flutterator-windows.exe
            REM Rename to flutterator.exe (optional)
            REM Add to PATH or run directly
            flutterator-windows.exe --help
            ```

            ## ğŸ¯ Features:
            - âœ… Flutter project creation with DDD Architecture
            - âœ… Complete feature generation (BLoC + Freezed + Injectable)
            - âœ… Rich CLI output with colors
            - âœ… Configuration via `flutterator.yaml`
            - âœ… **Zero dependencies** - single file executable

            ## ğŸ“‹ Commands:
            - `create` - New Flutter project
            - `add-feature` - Add DDD feature
            - `add-page` - Add simple page
            - `add-component` - Add reusable component
            - `init` - Initialize in existing project
            - `list` - List project resources
            - `config` - Manage configuration
          draft: false
          prerelease: false
          files: |
            release/flutterator-macos
            release/flutterator-linux
            release/flutterator-windows.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Latest Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: Flutterator Latest (${{ steps.version.outputs.version }})
          body: |
            ğŸš€ **Flutterator - Latest Stable (${{ steps.version.outputs.version }})**

            **No Python required!** Standalone executables for all platforms.

            ## ğŸ“¥ Direct Download Links (always latest):

            | Platform | Download |
            |----------|----------|
            | ğŸ macOS | [flutterator-macos](https://github.com/${{ github.repository }}/releases/download/latest/flutterator-macos) |
            | ğŸ§ Linux | [flutterator-linux](https://github.com/${{ github.repository }}/releases/download/latest/flutterator-linux) |
            | ğŸªŸ Windows | [flutterator-windows.exe](https://github.com/${{ github.repository }}/releases/download/latest/flutterator-windows.exe) |

            ## ğŸš€ One-liner install (macOS/Linux):
            ```bash
            curl -L -o flutterator "https://github.com/${{ github.repository }}/releases/download/latest/flutterator-$(uname -s | tr '[:upper:]' '[:lower:]' | sed 's/darwin/macos/')" && chmod +x flutterator && sudo mv flutterator /usr/local/bin/
            ```

            ---
            Version: ${{ steps.version.outputs.version }}
            Updated: ${{ steps.date.outputs.date }}
          draft: false
          prerelease: false
          files: |
            release/flutterator-macos
            release/flutterator-linux
            release/flutterator-windows.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
